---
description: プランのタスクを順次実行し、結果を記録する
---

# プラン実行

プランフォルダ内のタスクを順次実行し、結果を記録します。

## 核心原則

1. **検証駆動**: 各タスクの完了は検証基準で判断
2. **コンテキスト分離**: サブエージェントでタスクごとにコンテキストを分離
3. **早期軌道修正**: 2回失敗したら方針を見直す
4. **ノンストップ実行**: 成功している限り確認なしで進行
5. **まとめてコミット**: タスクごとではなく、全タスク完了後に1回コミット

## 使い方

```
/plan-run doc/plans/feature-2025-01-improvements
```

引数なしの場合、`doc/plans/` 内の最新プランを自動選択。

## 実行手順

### Step 1: ブランチ切り替えと開始

1. `README.md` を読み込み、ブランチ名とタスク一覧を把握
2. **ブランチに切り替え**（未作成なら作成）
   ```bash
   git checkout {branch-name} || git checkout -b {branch-name}
   ```
3. 進捗を簡潔に表示して即座に実行開始

### Step 2: タスク実行（サブエージェント）

`Task` ツール（general-purpose）で実行：

```
以下のタスクを実行してください。

## タスクファイル
{タスクファイルの内容}

## 開発原則
CLAUDE.mdの開発原則に従ってください。
参考ファイル（@記法）があれば、そのパターンに従うこと。

## 検証駆動で実装
1. まず検証基準を確認
2. 実装を行う
3. 検証を実行して成功を確認

## 実行後の必須作業
1. タスクファイルの「## 実装内容」「## 検証基準」のチェックボックスを全て [x] にする
2. 「## 実行結果」セクションにステータス・変更ファイル・検証結果を記録

## 完了条件
- 検証基準をすべて満たす
- `dotnet build` 成功
- `dotnet test` 成功

## 重要: コミットしない
このタスクではコミットを行わないでください。コミットは全タスク完了後にまとめて行います。

## 報告形式（簡潔に）
- ステータス: completed / blocked / failed
- 変更ファイル: リスト
- 検証結果: 通過/失敗
```

**コンテキスト管理**: サブエージェントが独立したコンテキストで動作するため、親のコンテキストは圧迫されない。

### Step 3: README.md 更新

タスク完了後、README.md の進捗チェックリストを更新：
```markdown
- [x] task-01 完了
```

### Step 4: 次のタスクへ（軌道修正判断）

**成功時**: Step 2 に戻り次のタスクを実行

**失敗時の軌道修正**:
1. **1回目の失敗**: 原因を分析し、アプローチを変えて再試行
2. **2回目の失敗**: 停止してユーザーに報告
   - 何を試したか
   - なぜ失敗したか
   - 提案する代替アプローチ

**ブロック時**: ユーザーに報告
- 不明な要件
- 必要な情報の不足
- 技術的制約

※ ただし、ブロックされていない独立したタスクがあれば先に進めてから報告する

### Step 5: テスト確認

全タスク完了後：

1. `dotnet test` で全テスト通過を確認
2. 新機能があればテストを追加（サブエージェントで実行）

### Step 6: ファイナルレビューとまとめてコミット（サブエージェント）

全タスク完了後、変更全体をレビューしてまとめてコミット。

`Task` ツール（general-purpose）で実行：

```
全タスク完了後のファイナルレビューとコミットを実行してください。

## 手順
1. .claude/commands/local-review.md を読み、その手順に従ってレビューを実行
   - 引数 `final`（ファイナルレビュー）モードで実行
2. 指摘があれば修正
3. 全変更をまとめてコミット

## コミット方針
- 全変更を1回のコミットにまとめる
- コミットメッセージは「feat: {プランの概要}」の形式
- メッセージ本文に主要な変更内容を箇条書きで記載

## 報告形式
- ステータス: completed
- 修正件数: N件
- コミット: {コミットハッシュ}
```

### Step 7: プラン完了

1. README.md の全チェックボックスを更新
2. **完了フォルダに移動**
   ```bash
   # doneフォルダがなければ作成
   mkdir -p doc/plans/done
   # プランフォルダを移動（git mv でgit履歴を保持）
   git mv doc/plans/{plan-folder} doc/plans/done/
   ```
3. **ダッシュボードHTML更新**（※ plan-batchから呼ばれた場合はスキップ）
   - `doc/plans/index.html` を編集
   - 完了したプランを「進行中」から「完了済み」セクションに移動
   - 進捗バーを100%に更新
   - バッジの数を更新
   - **注意**: `/plan-batch` から呼ばれた場合、この手順はスキップ（batch完了後にまとめて更新）
4. プラン移動をコミット（実装コミットとは別）
   ```bash
   git add doc/plans/
   git commit -m "chore: complete {plan-name}"
   ```
5. 完了報告

## 出力形式

**タスク完了時:**
```
## タスク {番号} 完了 → 次: {次のタスク名}
```

**プラン完了時:**
```
## プラン完了: {プラン名}
完了タスク: N / N
移動先: doc/plans/done/{plan-folder}/
```

## 注意事項

- 疑問は plan-new で解決済みのこと
- サブエージェントがチェックボックスを [x] に更新
- サブエージェントが実行結果セクションを記録
- 依存関係を無視して先のタスクを実行しない
- **検証基準を満たすまでタスクを完了としない**

## トラブルシューティング

| 状況 | 対応 |
|------|------|
| 同じエラーが2回続く | 停止してユーザーに報告、方針変更を相談 |
| コンテキストが大きくなりすぎた | タスク間でサブエージェントを使い続ける（自動分離） |
| 予期せぬ副作用が発生 | `git diff` で変更を確認し、必要なら `git checkout` で戻す |
| テストが想定外の理由で失敗 | 根本原因を調査、症状だけでなく原因を修正 |
