# タスク実行

plan.md の内容を愚直に実行し、done.md に完了報告を記録します。
複数タスクを指定した場合は順次実行し、各タスクごとに1コミットします。

## 使い方

```
/todo-run [タスクID] [タスクID2] [タスクID3] ...
```

### 引数の指定方法

| 指定方法 | 例 | 解決先 |
|---------|---|-------|
| 引数なし | `/todo-run` | todo.md の ToDo セクション全タスク |
| タスクID | `task-01` | `doc/todos/tasks/task-01/plan.md` |

### 例

```bash
# 引数なし → ToDoセクションの全タスクを順次実行
/todo-run

# 単一タスク
/todo-run task-02

# 複数タスク（順次実行）
/todo-run task-01 task-02 task-03
```

## 核心原則

1. **plan.md を愚直に実行**
2. **検証駆動**: 検証基準で完了判断
3. **コンテキスト分離**: サブエージェントで実行
4. **早期軌道修正**: 2回失敗したら方針見直し
5. **各タスク1コミット**: 複数タスク時も各完了時にコミット

## 実行手順

### Step 0: 準備

**1. タスク解決:**

| 引数 | アクション |
|------|----------|
| なし | `doc/todos/todo.md` の **ToDo** セクションから全タスクを抽出 |
| あり | 指定されたタスクIDを使用 |

- 各タスクIDを `doc/todos/tasks/{タスクID}/plan.md` に解決

**2. ブランチ判定:**

```bash
git branch --show-current
```

| 現在のブランチ | アクション |
|--------------|----------|
| `main` / `develop` | 新しいブランチを作成して切り替え |
| その他 | そのまま作業を続行 |

**ブランチ名の決定（main/develop時）:**

- 単一タスク: `todo/{task-id}` （例: `todo/task-02`）
- 複数タスク: タスク内容から最適な名前を生成
  - 例: task-01, task-02, task-03 → `todo/top-page-renewal`
  - 関連性がない場合: `todo/task-01-02-03`

```bash
git checkout -b todo/{ブランチ名}
```

### Step 1: 開始（各タスク）

1. plan.md を読む
2. todo.md で該当タスクを **Doing** に移動

### Step 2: タスク実行（サブエージェント）

`Task` ツール（general-purpose）で実行:

```
以下のタスクを実行してください。

## plan.md の内容
{plan.mdの全内容}

## 開発原則
CLAUDE.mdに従う。参考ファイル（@記法）のパターンに従う。

## 完了条件
- plan.mdの検証基準をすべて満たす
- ビルド成功
- テスト成功

コミットは後でまとめて行います。

## 報告形式
- ステータス: completed / blocked / failed
- 変更ファイル: リスト
- 検証結果: 通過/失敗
```

### Step 3: クイックレビュー（サブエージェント）

`Task` ツール（general-purpose）で実行:

```
.claude/commands/review.md の手順でクイックレビューを実行。
指摘があれば修正。コミットはしない。
```

### Step 4: 軌道修正判断

- **成功**: Step 5 へ
- **1回目失敗**: アプローチを変えて再試行
- **2回目失敗**: 当該タスクを failed として次のタスクへ

### Step 5: コミットと完了処理（各タスク）

**1. 変更をコミット:**
```bash
git add <変更ファイル>
git commit -m "feat: {タスク概要}"
```

**2. todo.md を更新:** 
- 階層も追従
```markdown
## Done
- [x] 認証機能を追加する
  - 機能
```

**3. done.md に記録:**

`done.md` に簡潔に記録（人間が読む用）:

```markdown
# 完了: 認証機能

## {タスクID}/次にやること
- `localhost:3000/login` で動作確認
- test@example.com / password でログイン
```

**ポイント**: 書きすぎない。次に何をすべきかが分かればOK。

**4. タスクフォルダを done/ に移動:**

```bash
# ディレクトリ構造
doc/todos/
├── todo.md
├── done.md
├── tasks/          # 未完了タスク
│   └── task-02/
└── done/           # 完了タスク
    └── task-01/

# 移動コマンド
mv doc/todos/tasks/task-xx doc/todos/done/
```

### Step 6: 次のタスクへ（ループ）

複数タスクの場合、Step 1-5 を繰り返す。

---

### Step 7: 総括レビューとドキュメントコミット（全タスク完了後）

**1. 総括レビュー（サブエージェント）:**

`Task` ツール（general-purpose）で実行:

```
今回の todo-run で実行した全タスクの総括レビューを行ってください。

## 実行したタスク
{タスク一覧}

## レビュー観点
- 全体の整合性
- タスク間の依存関係に問題がないか
- 見落としているエッジケースがないか
- セキュリティ上の問題がないか

問題がなければ「問題なし」と報告してください。
指摘があれば修正。
```

**2. ドキュメント&レビュー一括コミット:**

```bash
git add doc/todos/
git commit -m "docs: タスク管理ファイル更新"
```

**3. 最終報告:**

実行結果サマリを表示:
- 実行したタスク一覧と結果
- コミット履歴
- 次のステップ（マージ手順など）

---


**スキップ判定:**
- 前のタスクが failed でも、独立したタスクは続行
- 明示的な依存関係がある場合のみスキップ


## 注意事項

- plan.md を愚直に実行
- 検証基準を満たすまで完了としない
- done.md は簡潔に（ぺら1枚）
- 各タスクごとに1コミット（まとめない）
- 失敗タスクがあっても独立タスクは続行
- 並列実行が必要な場合は `/todo-batch` を使用
