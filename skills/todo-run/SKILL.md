---
name: todo-run
description: plan.mdのタスクを実行する。
---

# タスク実行

plan.md の内容を TDD サイクル（Red → Green → Refactor）で実行し、todo.md を更新します。
複数タスクを指定した場合は順次実行し、各タスクごとに1コミットします。

## 使い方

```
/todo-run [タスクID] [タスクID2] ...
```

### 引数の指定方法

| 指定方法 | 例 | 解決先 |
|---------|---|-------|
| 引数なし | `/todo-run` | todo.md の ToDo セクション全タスク |
| タスクID | `task-01` | `doc/todos/tasks/task-01/plan.md` |

### 例

```bash
# 引数なし → ToDoセクションの全タスクを順次実行
/todo-run

# 単一タスク
/todo-run task-02

# 複数タスク（順次実行）
/todo-run task-01 task-02 task-03
```

## 核心原則

1. **TDD（デフォルト）**: テストを先に書き、失敗を確認してから実装する。Red → Green → Refactor を厳守
2. **ゴール駆動**: plan.mdのゴール達成が完了基準（実装ステップの消化ではない）
3. **コンテキスト分離**: サブエージェントで実行
4. **早期軌道修正**: 2回失敗したら当該タスクをfailedとして次へ

### TDD スキップ条件

以下のいずれかに該当する場合、Step 2（Red）をスキップし Step 3（Green）から開始する:
- **CLAUDE.md でテストなしが明示されている**（例: 「このプロジェクトにテストはありません」）
- **plan.md に「テスト」セクションがない**（セットアップ系タスク等）

## 実行手順

### Step 0: 準備

**1. タスク解決:**

| 引数 | アクション |
|------|----------|
| なし | `doc/todos/todo.md` の ToDo セクションからタスクIDを抽出 |
| あり | 指定されたタスクIDを使用 |

- 各タスクIDを `doc/todos/tasks/{タスクID}/plan.md` に解決

**2. ブランチ判定:**

```bash
git branch --show-current
```

| 現在のブランチ | アクション |
|--------------|----------|
| `main` / `develop` | 新しいブランチを作成して切り替え |
| その他 | そのまま作業を続行 |

**ブランチ名の決定（main/develop時）:**

- 単一タスク: `todo/{task-id}` （例: `todo/task-02`）
- 複数タスク: タスク内容から最適な名前を生成
  - 例: task-01, task-02, task-03 → `todo/top-page-renewal`
  - 関連性がない場合: `todo/task-01-02-03`

```bash
git checkout -b todo/{ブランチ名}
```

### Step 1: 開始（各タスク）

1. plan.md を読む
2. **ゴールを確認する**（plan.mdの「ゴール」セクション）
3. todo.md で該当タスクを **Doing** に移動

### Step 2: Red — テストを書いて失敗させる（サブエージェント）

`Task` ツール（general-purpose）で実行:

```
以下のタスクの **テストだけ** を書いてください。実装コードはまだ書かないでください。

## plan.md の内容
{plan.mdの全内容}

## 開発原則
CLAUDE.mdに従う。参考ファイル（@記法）のパターンに従う。

## やること
plan.md の「実装ステップ > テスト」セクションに書かれたテストを作成する。
テストが存在しないタスク（環境セットアップ等）の場合は、その旨報告して終了。

## やらないこと
- テスト対象の実装コードを書くこと（インターフェース/型定義の最小スタブは可）
- テストを通すこと（この時点では全て失敗するのが正しい）

## 完了後
テストを実行し、**失敗することを確認**して結果を報告する。

コミットは後でまとめて行います。

## 報告形式
- テスト実行結果: X failed（期待通り）
- 作成したテストファイル: リスト
```

**Red 確認:**
サブエージェントの報告でテストが失敗していることを確認する。
- テストが失敗 → Step 3 へ
- テストがない（セットアップ系タスク）→ Step 3 へ（テストなしで実装）
- テストが成功してしまう → テストが正しくない可能性。サブエージェントに修正を指示

### Step 3: Green — 実装してテストを通す（サブエージェント）

`Task` ツール（general-purpose）で実行:

```
以下のタスクを実装し、テストを通してください。

## plan.md の内容
{plan.mdの全内容}

## 開発原則
CLAUDE.mdに従う。参考ファイル（@記法）のパターンに従う。

## やること
plan.md の「実装ステップ > 実装」セクションを実行する。
**テストが通る最小限の実装** を書く。過剰な実装は避ける。

## 完了条件
- テストが全て通る（Green）
- plan.mdの「自動検証」セクションの項目をすべて満たしている
- 既存テストが壊れていない

コミットは後でまとめて行います。

## 報告形式
- ステータス: completed / blocked / failed
- テスト実行結果: X passed
- 変更ファイル: リスト
- ゴール達成状況: 各ゴール項目の達成/未達
```

### Step 4: 自動検証

plan.md の「自動検証」セクションの各項目を**1つずつ実行して合否判定**する。

**検証方法:**
| 検証タイプ | 実行方法 |
|-----------|---------|
| ビルド | プロジェクトのビルドコマンドを実行し、exit code 0 を確認 |
| テスト | 関連テストを実行し、全パスを確認 |
| ファイル存在 | `Glob` で対象ファイルの存在を確認 |
| メソッド・クラス存在 | `Grep` で対象コード内にシンボルが存在するか確認 |
| 統合確認 | `Grep` で呼び出し元に組み込まれているか確認 |

**結果を記録:**
```
## 自動検証結果
- [x] ビルドが成功する → OK
- [x] 関連テストが全パスする → OK (3 passed)
- [ ] マイグレーションファイルが生成されている → NG（ファイルなし）
```

### Step 4.5: クイックレビュー

`git diff` で変更内容を確認し、以下の観点でチェック:
- 構文エラー、型エラーがないか
- セキュリティ上の問題（インジェクション、XSS等）
- 明らかなバグやロジックミス
- CLAUDE.md の規約違反

問題があれば修正し、テストが通ることを再確認する。

### Step 5: 軌道修正判断

自動検証結果に基づいて判断する:

- **全項目OK**: Step 6 へ
- **NG項目あり（1回目）**: NG項目に対応するコードを修正し、再度 Step 4 の自動検証を実行
- **NG項目あり（2回目）**: 当該タスクを failed として次のタスクへ

### Step 6: コミットと完了処理（各タスク）

**1. plan.mdを更新:**
完了した実装ステップにチェックを付ける。

**2. コード + plan.md をコミット:**
```bash
git add <変更ファイル> doc/todos/tasks/task-xx/plan.md
git commit -m "feat: {タスク概要}"
```

**3. todo.md を更新（コミットはしない。Step 8でまとめてコミット）:**

タスクを **Doing** から **Done** に移動し、「次にやること」を記録する。
「次にやること」はplan.mdの「手動検証」セクションの項目を転記する。

```markdown
## Done
# 確認だけで済むケース → シンプルに
- [x] SNS情報更新
  - 次にやること: YouTubeリンクが正しく表示されることを確認

# 手動操作が必要なケース → 手順がわかるように
- [x] 一括変換スクリプト作成
  - 次にやること
    - 本番DBでDataMigrationServiceを手動実行
    - 実行後にパフォーマンス比較を実施
    - 旧テーブルとの件数一致を確認
```

**書き方の基準:**
- 見ればわかる確認 → 1行
- 手動操作や複数ステップ → 箇条書きで手順を分ける
- どちらも「何をすればゴール達成を確認できるか」を書く

**4. タスクフォルダを done/ に移動（コミットはしない。Step 8でまとめてコミット）:**

```bash
mv doc/todos/tasks/task-xx doc/todos/done/
```

### Step 7: 次のタスクへ（ループ）

複数タスクの場合、Step 1-6 を繰り返す。

- 前のタスクが failed でも、独立したタスクは続行
- 明示的な依存関係がある場合のみスキップ

### Step 8: 総括レビューとドキュメントコミット（全タスク完了後）

**1. 総括レビュー（サブエージェント）:**

`Task` ツールで全変更の最終チェック:

```
今回の todo-run で実行した全タスクの総括レビューを行ってください。

## 実行したタスク
{タスク一覧}

## レビュー観点
- 全体の整合性
- タスク間の依存関係に問題がないか
- 見落としているエッジケースがないか
- セキュリティ上の問題がないか

問題がなければ「問題なし」と報告してください。
指摘があれば修正。
```

**2. ドキュメント一括コミット（todo.md + done/への移動）:**
```bash
git add doc/todos/
git commit -m "docs: タスク管理ファイル更新"
```

**3. 最終報告:**

実行結果サマリを表示:
- 実行したタスク一覧と結果
- 次のステップ（マージ手順など）
